<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stochastic vs Real Clock</title>
  <style>
    body { 
      font-family: sans-serif; 
      text-align: center; 
      margin: 20px; 
      background: #f9f9f9;
    }
    .controls { 
      margin-bottom: 30px; 
      display: flex; 
      justify-content: center; 
      gap: 20px; 
      flex-wrap: wrap; 
    }
    .controls-group { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
    }
    button, input[type="number"] {
      font-size: 16px;
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.2);
    }
    button:hover {
      background-color: #eef;
    }
    .clocks-container { 
      display: flex; 
      justify-content: center; 
      gap: 50px; 
      flex-wrap: wrap; 
      margin-bottom: 30px;
    }
    .clock {
      position: relative; 
      width: 300px; 
      height: 300px; 
      border: 5px solid black; 
      border-radius: 50%; 
      margin: auto; 
      background: white;
      box-shadow: 3px 3px 10px rgba(0,0,0,0.3);
    }
    .hand {
      position: absolute; 
      bottom: 50%; 
      left: 50%; 
      transform-origin: bottom center;
    }
    .second { width: 2px; height: 140px; background: red; }
    .minute { width: 4px; height: 100px; background: black; }
    .hour { width: 6px; height: 60px; background: black; }
    canvas#deviationChart, canvas#histogramCanvas { 
      border: 1px solid black; 
      margin-top: 20px; 
      max-width: 95vw; 
      background: white;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
    canvas#stoch_overlay, canvas#real_overlay { border: none; }
    @media (max-width: 700px) {
      .clocks-container { flex-direction: column; gap: 20px; }
    }
  </style>
</head>
<body>
  <h1>Stochastic Clock vs Real Clock</h1>
  <div class="controls">
    <button id="startNormal">Start Normally</button>
    <div class="controls-group">
      <button id="startWithHistory">Start with Backward Ticks</button>
      <input type="number" id="historyLength" value="10000" min="0" style="width:100px; margin-top:10px;">
    </div>
    <button id="reset">Reset</button>
  </div>
  <div class="clocks-container">
    <div>
      <h2>Real Clock</h2>
      <div class="clock">
        <canvas id="real_overlay" width="300" height="300" style="position:absolute; top:0; left:0;"></canvas>
        <div class="hand hour" id="real_hour"></div>
        <div class="hand minute" id="real_minute"></div>
        <div class="hand second" id="real_second"></div>
      </div>
    </div>
    <div>
      <h2>Stochastic Clock</h2>
      <div class="clock" id="stoch_clock">
        <canvas id="stoch_overlay" width="300" height="300" style="position:absolute; top:0; left:0;"></canvas>
        <div class="hand hour" id="stoch_hour"></div>
        <div class="hand minute" id="stoch_minute"></div>
        <div class="hand second" id="stoch_second"></div>
      </div>
    </div>
  </div>
  <p>Deviation: <span id="deviation">0</span> seconds | Latest Tick: <span id="latestTick">0</span> seconds</p>
  <h3>Deviation Over Time</h3>
  <canvas id="deviationChart" width="800" height="200"></canvas>
  <h3>Tick Distribution</h3>
  <canvas id="histogramCanvas" width="800" height="200"></canvas>

  <script>
    let realInterval, stochasticInterval;
    let trueTime, stochTime, previousStochTime, previousRealTime;
    let deviationHistory = [], tickHistory = [], histogram = {};

    function gaussianRandom(mean, stdDev) {
      let u = 0, v = 0;
      while(u === 0) u = Math.random();
      while(v === 0) v = Math.random();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v) * stdDev + mean;
    }

    function updateHand(prefix, timeInSeconds) {
      let seconds = timeInSeconds % 60;
      let minutes = Math.floor(timeInSeconds / 60) % 60;
      let hours = Math.floor(timeInSeconds / 3600) % 12;
      document.getElementById(prefix + '_second').style.transform = `rotate(${seconds * 6}deg)`;
      document.getElementById(prefix + '_minute').style.transform = `rotate(${minutes * 6 + seconds * 0.1}deg)`;
      document.getElementById(prefix + '_hour').style.transform = `rotate(${hours * 30 + minutes * 0.5}deg)`;
    }

    function tickColor(tick) {
      let norm = Math.max(-3, Math.min(3, tick)) / 3;
      let r = norm > 0 ? Math.floor(255 * norm) : 0;
      let b = norm < 0 ? Math.floor(255 * -norm) : 0;
      let g = 255 - Math.max(r, b);
      return `rgba(${r},${g},${b},0.3)`;
    }

    function drawSector(start, end, ctx, color) {
      let cx = 150, cy = 150, radius = 140;
      let sa = ((start % 60) * 6 - 90) * Math.PI / 180;
      let ea = ((end % 60) * 6 - 90) * Math.PI / 180;
      if (end - start >= 0 && ea < sa) ea += 2 * Math.PI;
      if (end - start < 0 && sa < ea) sa += 2 * Math.PI;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radius, sa, ea, (end - start) < 0);
      ctx.closePath();
      ctx.fillStyle = color;
      ctx.fill();
      ctx.fillStyle = 'black';
      ctx.font = '16px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      for (let i = 1; i <= 12; i++) {
        let angle = (i * 30 - 90) * Math.PI / 180;
        let x = cx + Math.cos(angle) * 120;
        let y = cy + Math.sin(angle) * 120;
        ctx.fillText(i, x, y);
      }
    }

    function initializeClocks() {
      let now = new Date();
      trueTime = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
      previousRealTime = trueTime;
      deviationHistory = [], tickHistory = [], histogram = {};
      clearCanvases();
    }

    function clearCanvases() {
      ['real_overlay','stoch_overlay','deviationChart','histogramCanvas'].forEach(id => {
        let ctx = document.getElementById(id).getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      });
    }

    function startSimulation() {
      clearInterval(realInterval);
      clearInterval(stochasticInterval);
      updateHand("real", trueTime);
      updateHand("stoch", stochTime);
      realInterval = setInterval(realTick, 1000);
      stochasticInterval = setInterval(stochasticTick, 1000);
    }

    function realTick() {
      previousRealTime = trueTime;
      trueTime++;
      let ctx = document.getElementById('real_overlay').getContext('2d');
      ctx.clearRect(0,0,300,300);
      drawSector(previousRealTime, trueTime, ctx, tickColor(1));
      updateHand("real", trueTime);
    }

    function stochasticTick() {
      let tick = Math.round(gaussianRandom(1,2));
      previousStochTime = stochTime;
      stochTime += tick;
      document.getElementById("latestTick").innerText = tick;
      let ctx = document.getElementById('stoch_overlay').getContext('2d');
      ctx.clearRect(0,0,300,300);
      drawSector(previousStochTime, stochTime, ctx, tickColor(tick));
      updateHand("stoch", stochTime);
      let deviation = stochTime - trueTime;
      document.getElementById("deviation").innerText = deviation;
      deviationHistory.push(deviation); if (deviationHistory.length > 200) deviationHistory.shift();
      tickHistory.push(tick); if (tickHistory.length > 50) tickHistory.shift();
      histogram[tick] = (histogram[tick]||0)+1;
      drawDeviationChart();
      drawHistogram();
    }

    function drawDeviationChart() {
      let ctx = document.getElementById('deviationChart').getContext('2d');
      ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
      let max = Math.max(...deviationHistory.map(Math.abs), 1);
      ctx.strokeStyle='gray';
      ctx.beginPath(); ctx.moveTo(50, 0); ctx.lineTo(50, ctx.canvas.height); ctx.stroke();
      for (let i = -4; i <= 4; i++) {
        let yVal = i * max / 4;
        let y = ctx.canvas.height/2 - yVal * (ctx.canvas.height/2-20)/max;
        ctx.beginPath(); ctx.moveTo(45, y); ctx.lineTo(50, y); ctx.stroke();
        ctx.fillStyle = 'black';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(yVal.toFixed(1), 45, y+4);
      }
      ctx.strokeStyle='black';
      ctx.beginPath(); ctx.moveTo(50, ctx.canvas.height/2); ctx.lineTo(ctx.canvas.width, ctx.canvas.height/2); ctx.stroke();
      ctx.beginPath();
      deviationHistory.forEach((v,i) => {
        let x = 50+i/(200)*(ctx.canvas.width-50);
        let y = ctx.canvas.height/2 - v*(ctx.canvas.height/2-20)/max;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.strokeStyle='red'; ctx.stroke();
    }

    function drawHistogram() {
      let ctx = document.getElementById('histogramCanvas').getContext('2d');
      ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
      let keys = Object.keys(histogram).map(Number).sort((a,b)=>a-b);
      if(keys.length===0) return;
      let binW = ctx.canvas.width / keys.length;
      let maxC = Math.max(...keys.map(k=>histogram[k]));
      keys.forEach((k,i) => {
        let x = i*binW;
        let h = histogram[k]/maxC*(ctx.canvas.height-20);
        ctx.fillStyle=tickColor(k);
        ctx.fillRect(x, ctx.canvas.height-h, binW-2, h);
        ctx.fillStyle='black';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(k, x+binW/2, ctx.canvas.height-5);
      });
    }

    document.getElementById("startNormal").onclick = () => {
      initializeClocks();
      stochTime = trueTime;
      previousStochTime = stochTime;
      startSimulation();
    }

    document.getElementById("startWithHistory").onclick = () => {
      initializeClocks();
      let history = parseInt(document.getElementById("historyLength").value)||0;
      stochTime = trueTime - history;
      for (let i = 0; i < history; i++) {
        let tick = Math.round(gaussianRandom(1, 2));
        stochTime += tick;
      }
      previousStochTime = stochTime;
      startSimulation();
    }

    document.getElementById("reset").onclick = () => {
      clearInterval(realInterval);
      clearInterval(stochasticInterval);
      initializeClocks();
    }
  </script>
</body>
</html>
